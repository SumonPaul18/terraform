# тШБя╕П OpenStack Simple VM Instance тАУ Terraform Example

> тЪая╕П **ржПржЗ ржкрзНрж░ржЬрзЗржХрзНржЯржЯрж┐ рж╢рзБржзрзБржорж╛рждрзНрж░ рж╢рзЗржЦрж╛рж░ ржЙржжрзНржжрзЗрж╢рзНржпрзЗ**ред рждржмрзЗ ржПржЯрж┐ ржПржХржЯрж┐ ржкрзНрж░рзЛржбрж╛ржХрж╢ржи-рж╕рж╛ржоржЮрзНржЬрж╕рзНржпржкрзВрж░рзНржг ржнрж┐рждрзНрждрж┐ рж╣рж┐рж╕рзЗржмрзЗржУ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржпрж╛ржпрж╝ред

---

## ЁЯОп ржЙржжрзНржжрзЗрж╢рзНржп (Objective)

ржПржЗ Terraform ржЙржжрж╛рж╣рж░ржгржЯрж┐ ржжрж┐ржпрж╝рзЗ ржЖржкржирж┐ рж╢рж┐ржЦржмрзЗржи:

- **OpenStack ржХрзНрж▓рж╛ржЙржбрзЗ** ржПржХржЯрж┐ **VM ржЗржирж╕рзНржЯрзНржпрж╛ржирзНрж╕** рждрзИрж░рж┐ ржХрж░рждрзЗ  
- **рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ SSH keypair** ржЬрзЗржирж╛рж░рзЗржЯ ржУ ржЖржкрж▓рзЛржб ржХрж░рждрзЗ  
- **Floating IP** рждрзИрж░рж┐ ржХрж░рзЗ VM-ржП ржЕрзНржпрж╛ржЯрж╛ржЪ ржХрж░рждрзЗ  
- **SSH ржХржорж╛ржирзНржб** ржЖржЙржЯржкрзБржЯрзЗ ржжрзЗржЦрзЗ VM-ржП ржХрж╛ржирзЗржХрзНржЯ ржХрж░рждрзЗ  
- **Terraform variables** ржжрж┐ржпрж╝рзЗ ржбрж╛ржЗржирж╛ржорж┐ржХ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ

---

## ЁЯУБ ржлрж╛ржЗрж▓ ржХрж╛ржарж╛ржорзЛ (File Structure)

```
examples/openstack/simple-instance/
тФЬтФАтФА provider.tf        # OpenStack Provider + clouds.yaml ржмрзНржпржмрж╣рж╛рж░
тФЬтФАтФА main.tf            # VM, Keypair, Floating IP ржПрж░ рж░рж┐рж╕рзЛрж░рзНрж╕
тФЬтФАтФА variables.tf       # ржЗржиржкрзБржЯ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ ржбрж┐ржлрж┐ржирж┐рж╢ржи
тФЬтФАтФА outputs.tf         # ржлрзНрж▓рзЛржЯрж┐ржВ IP, SSH ржХржорж╛ржирзНржб ржЖржЙржЯржкрзБржЯ
тФЬтФАтФА terraform.tfvars   # ржЖржкржирж╛рж░ ржкрж╛рж░рзНрж╕рзЛржирж╛рж▓ ржнрзНржпрж╛рж▓рзБ (ржХрзНрж▓рж╛ржЙржб, ржЗржорзЗржЬ, ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржЗрждрзНржпрж╛ржжрж┐)
тФФтФАтФА .terraform/        # (auto-generated тАУ ржЧрж┐ржЯрзЗ ржХржорж┐ржЯ ржХрж░ржмрзЗржи ржирж╛!)
```

> тЭЧ **ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг**:  
> - `terraform.tfstate`, `.terraform/`, `clouds.yaml`, `*.tfvars` ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ **ржЧрж┐ржЯрзЗ ржХржорж┐ржЯ ржХрж░ржмрзЗржи ржирж╛**  
> - рж░рж┐ржкрзЛрж░ `.gitignore` ржлрж╛ржЗрж▓рзЗ ржПржЧрзБрж▓рзЛ ржЕржмрж╢рзНржпржЗ ржпрзЛржЧ ржХрж░рзБржи

---

## ЁЯЫа ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ рж╢рж░рзНрждрж╛ржмрж▓рзА (Prerequisites)

1. **OpenStack ржХрзНрж▓рж╛ржЙржб** ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕ (UI ржмрж╛ CLI)  
2. **OpenStack CLI ржЯрзБрж▓рж╕** ржЗржирж╕рзНржЯрж▓ (`python3-openstackclient`)  
3. **Terraform** ржЗржирж╕рзНржЯрж▓ (`v1.5+`)  
4. **SSH key pair** (`~/.ssh/id_ed25519.pub` ржмрж╛ `~/.ssh/id_rsa.pub`)  
5. **OpenStack `clouds.yaml`** ржлрж╛ржЗрж▓ (ржЕржержмрж╛ ржЖржкржирж┐ ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ credentials ржжрж┐рждрзЗ ржкрж╛рж░рзЗржи)

---

## ЁЯФС ржзрж╛ржк рзз: OpenStack Credential рж╕рзЗржЯржЖржк

> тЬЕ **рж╕рзБржкрж╛рж░рж┐рж╢ржХрзГржд ржкржжрзНржзрждрж┐**: `clouds.yaml` ржлрж╛ржЗрж▓ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи

### 1.1 `clouds.yaml` ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзБржи

- OpenStack ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржбрзЗ ржпрж╛ржи тЖТ **API Access** тЖТ **Download OpenStack RC File** (`v3`)
- ржлрж╛ржЗрж▓ржЯрж┐ ржЦрзБрж▓рзБржи ржПржмржВ ржПржЯрж┐ ржерзЗржХрзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд рждржерзНржпржЧрзБрж▓рзЛ ржмрзЗрж░ ржХрж░рзБржи:
  - `auth_url`
  - `username`
  - `password`
  - `project_name`
  - `user_domain_name`
  - `project_domain_name`
  - `region_name`

### 1.2 `~/.config/openstack/clouds.yaml` рждрзИрж░рж┐ ржХрж░рзБржи

```bash
mkdir -p ~/.config/openstack
nano ~/.config/openstack/clouds.yaml
```

ржЙржжрж╛рж╣рж░ржг (`clouds.yaml`):

```yaml
clouds:
  openstack:
    auth:
      auth_url: http://192.168.1.100:5000/v3
      username: "sumon"
      password: "your_openstack_password"
      project_name: "demo"
      user_domain_name: "Default"
      project_domain_name: "Default"
    region_name: "RegionOne"
    interface: "public"
    identity_api_version: 3
```

> ЁЯУМ ржЖржкржирж╛рж░ ржХрзНрж▓рж╛ржЙржбрзЗрж░ ржирж╛ржо `openstack` тАФ `provider.tf`-ржП ржПржЯрж┐ рж░рзЗржлрж╛рж░рзЗржирзНрж╕ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ

### 1.3 ржЕржержмрж╛ржГ clouds.yaml ржХрж╛рж╕рзНржЯржо ржкрж╛рже Environment File рж╣рж┐рж╕рж╛ржмрзЗ `OS_CLIENT_CONFIG_FILE` Export ржХрж░рзБржи

```
export OS_CLIENT_CONFIG_FILE="/home/sumon/Downloads/clouds.yaml"
```
> **Note:** ржпрзЗржоржи ржПржЦрж╛ржирзЗ clouds.yaml ржлрж╛ржЗрж▓ржЯрж┐ `/home/sumon/Downloads/` ржПржЗ рж▓рзЛржХрзЗрж╢ржирзЗ ржЖржЫрзЗред

---

## ЁЯУе ржзрж╛ржк рзи: ржЧрж┐ржЯрж╣рж╛ржм рж░рж┐ржкрзЛржЬрж┐ржЯрж░рж┐ ржХрзНрж▓рзЛржи ржУ ржкрзНрж░ржЬрзЗржХрзНржЯ рж╕рзЗржЯржЖржк

```bash
# 1. рж░рж┐ржкрзЛржЬрж┐ржЯрж░рж┐ ржХрзНрж▓рзЛржи ржХрж░рзБржи
git clone https://github.com/SumonPaul18/terraform.git
cd terraform/examples/openstack/simple-instance

# 2. terraform.tfvars ржЖржкржбрзЗржЯ ржХрж░рзБржи (ржЖржкржирж╛рж░ ржХрзНрж▓рж╛ржЙржб ржЕржирзБржпрж╛ржпрж╝рзА)
nano terraform.tfvars
```

### ЁЯУЭ `terraform.tfvars` ржПрж░ ржЙржжрж╛рж╣рж░ржг:

```hcl
# VM Configuration
instance_name     = "my-vm"
image_name        = "Ubuntu-22.04"   # Glance ржП ржЖржкржирж╛рж░ ржЗржорзЗржЬрзЗрж░ ржирж╛ржо
flavor_name       = "m1.small"      # Nova flavor
network_name      = "private"       # ржЖржкржирж╛рж░ internal network
floating_ip_pool  = "public"        # external network (floating IP)

# SSH Key
ssh_key_name      = "my-key"
ssh_public_key_path = "~/.ssh/id_ed25519.pub"
```

> ЁЯТб **ржЗржорзЗржЬ/ржлрзНрж▓рзЗржнрж╛рж░/ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржирж╛ржо** ржЖржкржирж╛рж░ OpenStack ржХрзНрж▓рж╛ржЙржбрзЗрж░ **ржбрзНржпрж╛рж╢ржмрзЛрж░рзНржб ржмрж╛ CLI** ржерзЗржХрзЗ ржЪрзЗржХ ржХрж░рзБржи:
> ```bash
> openstack image list
> openstack flavor list
> openstack network list
> ```

---

## ЁЯз▒ ржзрж╛ржк рзй: Terraform Initialize & Plan

```bash
# 1. Provider plugin ржбрж╛ржЙржирж▓рзЛржб
terraform init

# 2. ржкрзНрж░рж┐ржнрж┐ржЙ ржжрзЗржЦрзБржи (ржХрзЛржирзЛ рж░рж┐рж╕рзЛрж░рзНрж╕ рждрзИрж░рж┐ рж╣ржмрзЗ ржирж╛)
terraform plan
```

тЬЕ ржЖржЙржЯржкрзБржЯрзЗ ржжрзЗржЦрзБржи:
- `+ create openstack_compute_keypair_v2`
- `+ create openstack_compute_instance_v2`
- `+ create openstack_networking_floatingip_v2`
- `+ create openstack_compute_floatingip_associate_v2`

---

## тЦ╢я╕П ржзрж╛ржк рзк: ржЗржиржлрзНрж░рж╛рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рзБржи

```bash
# Apply ржХрж░рзБржи
terraform apply
```

> ЁЯУМ ржкрзНрж░ржорзНржкржЯрзЗ **`yes`** ржЯрж╛ржЗржк ржХрж░рзБржи

---

## ЁЯОЙ ржЖржЙржЯржкрзБржЯ (After Apply)

```
Apply complete! Resources: 4 added, 0 changed, 0 destroyed.

Outputs:

floating_ip = "192.168.0.224"
instance_name = "my-vm"
ssh_command = "ssh -i ~/.ssh/id_ed25519.pub ubuntu@192.168.0.224"
```

> ЁЯФС **SSH ржХржорж╛ржирзНржб ржЕржирзБржпрж╛ржпрж╝рзА рж▓ржЧржЗржи ржХрж░рзБржи**  
> - ржЗржорзЗржЬ ржЕржирзБржпрж╛ржпрж╝рзА ржЗржЙржЬрж╛рж░ржирзЗржо ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи (ржпрзЗржоржи: `cirros`, `centos`, `ubuntu`)

---

## ЁЯз╣ ржзрж╛ржк рзл: рж░рж┐рж╕рзЛрж░рзНрж╕ ржорзБржЫрзБржи (ржРржЪрзНржЫрж┐ржХ)

```bash
# рж╕ржм рж░рж┐рж╕рзЛрж░рзНрж╕ рж╕ржорзНржкрзВрж░рзНржг ржорзБржЫрзЗ ржлрзЗрж▓рзБржи
terraform destroy
```

> тЬЕ Floating IP, VM, Keypair тАФ рж╕ржмржХрж┐ржЫрзБ ржЕржЯрзЛржорзЗржЯрж┐ржХ ржХрзНрж▓рж┐ржиржЖржк рж╣ржмрзЗ

---

## ЁЯФН ржлрж╛ржЗрж▓ ржмрзНржпрж╛ржЦрзНржпрж╛ (Per File Overview)

### ЁЯУД `provider.tf`
```hcl
provider "openstack" {
  cloud = "openstack"  # ~/.config/openstack/clouds.yaml ржПрж░ key
}
```
- ржХрзНрж░рзЗржбрзЗржирж╢рж┐ржпрж╝рж╛рж▓ `clouds.yaml` ржерзЗржХрзЗ ржирзЗржпрж╝
- ржХрзЛржирзЛ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб/ржХрзА ржХрзЛржбрзЗ рж▓рзБржХрж╛ржирзЛ ржирзЗржЗ тЖТ **рж╕рж┐ржХрж┐ржЙрж░**

### ЁЯУД `main.tf`
4ржЯрж┐ рж░рж┐рж╕рзЛрж░рзНрж╕:
1. **Keypair**: ржЖржкржирж╛рж░ `~/.ssh/*.pub` ржлрж╛ржЗрж▓ ржерзЗржХрзЗ OpenStack-ржП ржЖржкрж▓рзЛржб ржХрж░рж╛ рж╣ржпрж╝
2. **VM Instance**: ржкрзНрж░ржжрждрзНржд ржЗржорзЗржЬ, ржлрзНрж▓рзЗржнрж╛рж░, ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ
3. **Floating IP**: public pool ржерзЗржХрзЗ ржПржХржЯрж┐ IP ржЕрзНржпрж╛рж▓рзЛржХрзЗржЯ ржХрж░рзЗ
4. **Association**: Floating IP VM-ржП ржЕрзНржпрж╛ржЯрж╛ржЪ ржХрж░рзЗ

### ЁЯУД `variables.tf`
- `instance_name`, `image_name`, `flavor_name` ржЗрждрзНржпрж╛ржжрж┐ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░рж╛ржЗржЬржб
- ржХрж╛рж╕рзНржЯржорж╛ржЗржЬрзЗрж╢ржи рж╕рж╣ржЬ

### ЁЯУД `outputs.tf`
- рж╕рж░рж╛рж╕рж░рж┐ **SSH ржХржорж╛ржирзНржб** ржЖржЙржЯржкрзБржЯ ржжрзЗржпрж╝ тЖТ ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржХрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗ

---

## тЪая╕П рж╕рждрж░рзНржХрждрж╛ ржУ ржмрзЗрж╕рзНржЯ ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕

| ржмрж┐рж╖ржпрж╝ | ржмрзНржпрж╛ржЦрзНржпрж╛ |
|------|--------|
| ЁЯФТ **ржХрзНрж░рзЗржбрзЗржирж╢рж┐ржпрж╝рж╛рж▓ ржЧрзЛржкржи рж░рж╛ржЦрзБржи** | `clouds.yaml` ржПржмржВ `*.tfvars` ржЧрж┐ржЯрзЗ ржХржорж┐ржЯ ржХрж░ржмрзЗржи ржирж╛ |
| ЁЯТ░ **ржЦрж░ржЪ/рж░рж┐рж╕рзЛрж░рзНрж╕ ржХржирзНржЯрзНрж░рзЛрж▓** | ржХрж╛ржЬ рж╢рзЗрж╖рзЗ `destroy` ржХрж░рзБржи, ржмрж┐рж╢рзЗрж╖ ржХрж░рзЗ Floating IP |
| ЁЯУВ **State ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ** | ржЯрж┐ржо ржкрзНрж░ржЬрзЗржХрзНржЯрзЗ **S3/GCS + Locking** remote backend ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи |
| ЁЯМР **ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржорзНржпрж╛ржЪ** | `network_name` = internal, `floating_ip_pool` = external (public) ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ |

---

## ЁЯФз рж╕ржорж╕рзНржпрж╛ рж╕ржорж╛ржзрж╛ржи (Troubleshooting)

| рж╕ржорж╕рзНржпрж╛ | рж╕ржорж╛ржзрж╛ржи |
|--------|--------|
| **тАЬNo valid host availableтАЭ** | Flavor ржУ ржЗржорзЗржЬ compatible ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи |
| **Floating IP not assigned** | `floating_ip_pool` ржирж╛ржоржЯрж┐ OpenStack-ржПрж░ **external network** ржПрж░ рж╕рж╛ржерзЗ ржорж┐рж▓ржЫрзЗ ржХрж┐ржирж╛ |
| **SSH failed** | 1. ржЗржЙржЬрж╛рж░ржирзЗржо ржарж┐ржХ ржХрж┐ржирж╛ (ubuntu/cirros/centos)<br>2. Security group-ржП SSH (22) ржкрзЛрж░рзНржЯ open ржХрж┐ржирж╛ |
| **тАЬcloud openstack not foundтАЭ** | `clouds.yaml` ржлрж╛ржЗрж▓рзЗ `clouds:` ржмрзНрж▓ржХрзЗрж░ ржирж╛ржо `openstack` ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи |
| **Permission denied (publickey)** | `ssh_public_key_path` рж╕ржарж┐ржХ ржкрж╛ржмрж▓рж┐ржХ ржХрзА ржлрж╛ржЗрж▓рзЗрж░ ржкрже ржжрж┐ржи |

---

## ЁЯУЪ ржкрж░ржмрж░рзНрждрзА ржкржжржХрзНрж╖рзЗржк

- [ ] **Security Group** ржпрзЛржЧ ржХрж░рзБржи (SSH + HTTP ржЕрзНржпрж╛рж▓рж╛ржЙ)
- [ ] **Volume attach** ржХрж░рзБржи
- [ ] **User data (cloud-init)** ржжрж┐ржпрж╝рзЗ bootstrap ржХрж░рзБржи
- [ ] **Terraform Module** рждрзИрж░рж┐ ржХрж░рзБржи ржПржмржВ ржЕржирзНржп ржкрзНрж░ржЬрзЗржХрзНржЯрзЗ reuse ржХрж░рзБржи
- [ ] **GitHub Actions** ржжрж┐ржпрж╝рзЗ CI/CD рж╕рзЗржЯржЖржк ржХрж░рзБржи

---

> ЁЯЩМ **рж╕рж╛рж╣рж╛ржпрзНржп рж▓рж╛ржЧрж▓рзЗ**?  
> ржЗрж╕рзНржпрзБ ржЦрзБрж▓рзБржи: [GitHub Issues](https://github.com/SumonPaul18/terraform/issues)  
> ржЖржорж╛рж░ ржкрзНрж░рзЛржлрж╛ржЗрж▓: [Sumon Paul тАУ LinkedIn](https://www.linkedin.com/in/sumonpaul/) | [Portfolio](https://skpaul.netlify.app/)

---

тЬЕ **Happy OpenStacking with Terraform!** тШБя╕ПЁЯТ╗
